# Development Environment

A VS Code DevContainer configuration that provides isolated, reproducible
development environments with intelligent host integration.

## Features

- **Isolated Environment**: Container with sandboxed home directory to
  prevent pollution of host home
- **Claude AI Integration**: Automatic bind mounts for `.claude` config
  and state persistence
- **Smart Mount System**: Selective bind mounts preserve tool configurations
  while isolating the container
- **Automatic Setup**: Self-configuring initialization script
- **Cross-Platform**: Works on Windows, Linux, and macOS with automatic
  path translation
- **Development-Optimized Security**: Runs with elevated privileges for
  debugging and advanced development scenarios (development use only)

## Base Image

The development container is built on
[amery/docker-builder](https://github.com/amery/docker-builder), extending
the `docker-ubuntu-vsc-base-builder` image with:

- **Go**: Full Go development environment
- **Node.js**: JavaScript/TypeScript runtime and tooling
- **VS Code Server**: Pre-configured for DevContainer support
- **Build Tools**: Essential compilation and development utilities

The docker-builder project provides the foundation for this DevContainer,
including the base images, build system, and container runtime wrapper. For
details on available base images and the build infrastructure, see the
[docker-builder documentation](https://github.com/amery/docker-builder).

## Quick Start

### Prerequisites

- Docker installed and running
  - **Windows**: Docker Desktop with WSL 2 backend recommended
  - **macOS**: Docker Desktop
  - **Linux**: Docker Engine
- Visual Studio Code with "Dev Containers" extension
- Git
- Node.js (for cross-platform initialization)

### Setup

1. Clone the repository with submodules:

   ```bash
   git clone --recursive <repository-url>
   cd dev-env
   ```

   **Important**: If you forgot `--recursive`, initialize submodules before
   proceeding:

   ```bash
   git submodule update --init --recursive
   ```

   For detailed submodule management instructions, see
   [AGENT.md](./AGENT.md#submodule-management).

2. Open in VS Code:

   ```bash
   code .
   ```

3. When VS Code opens, click "Reopen in Container" when prompted
   (or use Command Palette → "Dev Containers: Reopen in Container")

The container will automatically initialize on first run. The initialization
process:

- Detects your operating system (Windows, Linux, or macOS)
- Runs the appropriate script (`init.ps1` for Windows, `init.sh` for
  Unix-like systems)
- Creates necessary directories and configures mounts for Claude AI
  integration
- Handles path translation on Windows (e.g., `C:\Users\john` →
  `/c/Users/john`)
- Generates a custom Dockerfile with user-specific metadata

## Project Structure

```text
.devcontainer/        # VS Code DevContainer configuration
├── devcontainer.json # Container settings and mounts (auto-updated)
├── Dockerfile        # Auto-generated by init scripts
├── init.js           # Cross-platform entry point (Node.js)
├── init.sh           # Linux/macOS initialization script
└── init.ps1          # Windows PowerShell initialization script

.docker-run-cache/   # Container runtime storage (git-ignored)
└── ${HOME}/        # Sandboxed home directory

docker/              # Base container definitions
├── Dockerfile       # Base image configuration
└── run.sh          # Container runtime script

bin/                 # Helper scripts
└── x               # Workspace helper (detection & container access)

run.sh              # Symlink to docker/run.sh (workspace root marker)
go.work             # Go workspace configuration
```

## The `x` Helper

The `x` script in `bin/` provides intelligent workspace detection and
command execution:

### Usage

```bash
# Find workspace root
x --root

# Execute command in container (if run.sh exists)
x make build

# Pass through command if no run.sh found
x echo "hello"
```

### How it Works

1. **Workspace Detection**: Searches for `run.sh` by checking:
   - `.repo` directory (for repo tool workspaces)
   - `.git` repository root
   - Parent directories up to root

2. **Container Execution**: If `run.sh` is found, trampolines commands
   through it for consistent container-based execution

3. **Fallback**: If no `run.sh` is found, executes commands directly

## Usage Examples

### Working with Go Projects

```bash
# From any subdirectory, use x to run commands in container
cd src/myapp
x go build ./...
x go test -v

# Check workspace root
x --root
```

### Development Workflow

```bash
# Open in VS Code with DevContainer
code .

# After container starts, your tools are available
go version      # Uses container's Go installation
make build      # Runs in consistent environment

# Claude AI config persists between sessions
claude --help   # If Claude CLI is installed
```

## Environment Variables

The container sets these environment variables:

- `WS`: Workspace folder path
- `CURDIR`: Current directory (same as workspace)
- `GOPATH`: Go path (set to workspace for Go projects)

## Troubleshooting

### Common Issues

- **"Reopen in Container" not appearing**: Ensure Docker is running and
  the Dev Containers extension is installed in VS Code
- **Mount permission errors**: Run `git status` to ensure the repository
  is clean, then rebuild the container
- **Claude configuration not persisting**: Ensure the init script ran
  successfully (it creates `~/.claude` if needed)
- **Windows path issues**: The system automatically detects WSL vs Docker
  Desktop and translates paths accordingly
- **Windows username issues**: Special characters and spaces in Windows
  usernames are automatically sanitized for Linux compatibility

### Rebuilding the Container

If you encounter issues, try rebuilding:

1. **Quick Rebuild**: Command Palette → "Dev Containers: Rebuild Container"
   - Reuses cached Docker layers when possible
   - Faster but may not pick up base image updates

2. **Clean Rebuild**: Command Palette → "Dev Containers: Rebuild Container
   Without Cache"
   - Removes all cached layers and rebuilds from scratch
   - Downloads latest base image updates
   - Ensures you have the newest versions of Go, Node.js, and tools

You can also access these options from VS Code's UI:

- Click the remote indicator (bottom-left corner)
- Select "Rebuild Container" or "Rebuild Container Without Cache"

## Relationship with docker-builder

This project is a specialized implementation of
[docker-builder](https://github.com/amery/docker-builder):

- **Extends**: Uses docker-builder's `docker-apptly-builder` base image
- **Leverages**: The `run.sh` script for container execution
- **Demonstrates**: How to create DevContainer environments on top of
  docker-builder infrastructure

When docker-builder is updated:

- Base image improvements automatically benefit this environment
- Breaking changes may require updates to the Dockerfile or configuration
- New features in `run.sh` become available through the symlink

## Documentation

- [AGENT.md](./AGENT.md) - Technical implementation details for AI agents
  and developers
- [LICENCE.txt](./LICENCE.txt) - Project license information
- [docker-builder](https://github.com/amery/docker-builder) - Base
  infrastructure documentation

## License

See [LICENCE.txt](./LICENCE.txt) for details.
